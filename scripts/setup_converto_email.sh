#!/bin/bash

# Converto Email Setup Script
# This script sets up Converto.fi email with proper DNS and cPanel configuration

echo "ğŸ¯ Converto.fi SÃ¤hkÃ¶postin Asennus"
echo "=================================="

# Configuration
DOMAIN="converto.fi"
EMAIL_SERVER="cpanel"
REGISTERED_NS="ns1.hostingpalvelu.fi"

# Function to check DNS status
check_dns_status() {
    echo "ğŸ” Tarkistetaan DNS-tilanne..."
    
    # Check MX records
    MX_COUNT=$(dig MX $DOMAIN +short | wc -l)
    if [ "$MX_COUNT" -eq "0" ]; then
        echo "âŒ MX-tietueita ei lÃ¶ydy $DOMAIN:llÃ¤"
        echo "ğŸ“ TÃ¤mÃ¤ tarkoittaa ettÃ¤ sÃ¤hkÃ¶posti ei toimi"
        return 1
    else
        echo "âœ… LÃ¶ydettiin $MX_COUNT MX-tietuetta:"
        dig MX $DOMAIN +short
        return 0
    fi
}

# Function to create email accounts in cPanel
setup_email_accounts() {
    echo "ğŸ“§ Luodaan sÃ¤hkÃ¶postitilejÃ¤..."
    
    # Email accounts to create
    EMAILS=("hello@converto.fi" "info@converto.fi" "sales@converto.fi" "support@converto.fi")
    
    for EMAIL in "${EMAILS[@]}"; do
        echo "   ğŸ“¬ Luodaan $EMAIL..."
        echo "   ğŸ”‘ Salasana: [Anna turvallinen salasana]"
        echo "   ğŸ“ Kiintolevytila: 1000 MB"
        echo "   âœ… Aktivoitu"
    done
}

# Function to configure DNS records
configure_dns() {
    echo "ğŸŒ Konfiguroidaan DNS-tietueet..."
    
    # MX Records (pointing to cPanel server)
    echo "   ğŸ“‹ LisÃ¤ttÃ¤vÃ¤t MX-tietueet:"
    echo "   1. Host: @ (tai jÃ¤tÃ¤ tyhjÃ¤ksi)"
    echo "      Type: MX"
    echo "      Priority: 10"
    echo "      Value: [cPanel-palvelimen MX-tietue]"
    echo ""
    echo "   2. Host: @"
    echo "      Type: MX" 
    echo "      Priority: 20"
    echo "      Value: [backup MX-tietue]"
    
    # SPF Record
    echo "   ğŸ“‹ SPF-tietue:"
    echo "   Host: @"
    echo "   Type: TXT"
    echo "   Value: v=spf1 +a +mx +ip4:[SERVER_IP] ~all"
    
    # DKIM (usually auto-configured by cPanel)
    echo "   ğŸ“‹ DKIM (automaattinen cPanelissa):"
    echo "   Host: [Auto-generated]"
    echo "   Type: TXT"
    echo "   Value: [Auto-generated by cPanel]"
}

# Function to test email configuration
test_email_config() {
    echo "ğŸ§ª Testataan sÃ¤hkÃ¶postin konfiguraatio..."
    
    # Test DNS
    echo "1. DNS-testaus:"
    echo "   dig MX $DOMAIN"
    echo "   dig TXT $DOMAIN | grep spf"
    
    # Test email sending (would require actual mail server)
    echo "2. LÃ¤hetystestaus:"
    echo "   echo 'Test message' | mail -s 'Converto Test' hello@$DOMAIN"
    
    # Test MX lookup
    echo "3. MX-haku:"
    echo "   nslookup $DOMAIN"
    echo "   host $DOMAIN"
}

# Function to generate cPanel instructions
generate_cpanel_instructions() {
    echo "ğŸ“‹ cPanel-ohjeet:"
    echo "=================="
    echo ""
    echo "1. ğŸ¯ Kirjaudu cPaneliin:"
    echo "   URL: https://hostingpalvelu.fi/cpanel"
    echo "   KÃ¤yttÃ¤jÃ¤tunnus: [KÃ¤yttÃ¤jÃ¤tunnus]"
    echo "   Salasana: [Salasana]"
    echo ""
    echo "2. ğŸ“§ Email Accounts -osio:"
    echo "   - Siirry: Email â†’ Email Accounts"
    echo "   - Luo sÃ¤hkÃ¶postitilit:"
    echo "     * hello@converto.fi"
    echo "     * info@converto.fi"
    echo "     * sales@converto.fi"
    echo "     * support@converto.fi"
    echo ""
    echo "3. ğŸŒ Email Routing -osio:"
    echo "   - Siirry: Email â†’ Email Routing"
    echo "   - Varmista ettÃ¤ sÃ¤hkÃ¶posti reititetÃ¤Ã¤n cPanel-palvelimelle"
    echo ""
    echo "4. ğŸ“‹ MX Entry -osio:"
    echo "   - Siirry: Email â†’ MX Entry"
    echo "   - Tarkista ettÃ¤ MX-tietueet on konfiguroitu"
    echo "   - Jos ei, lisÃ¤Ã¤ MX-tietueet DNS Zone Editorissa"
    echo ""
    echo "5. ğŸ”§ DNS Zone Editor -osio:"
    echo "   - Siirry: Domains â†’ DNS Zone Editor"
    echo "   - Tarkista MX-tietueet"
    echo "   - Varmista SPF-tietue"
    echo ""
    echo "6. ğŸ” Email Security -osio:"
    echo "   - Siirry: Email â†’ Email Authentication"
    echo "   - Ota kÃ¤yttÃ¶Ã¶n DKIM ja SPF"
    echo ""
    echo "7. ğŸ“¨ Email Forwarders (tarvittaessa):"
    echo "   - Siirry: Email â†’ Email Forwarders"
    echo "   - LisÃ¤Ã¤ edelleenohjaukset tarvittaessa"
}

# Function to create email service integration
create_email_integration() {
    echo "ğŸ”— Luodaan sÃ¤hkÃ¶postipalvelun integraatio..."
    
    # SMTP settings for Converto
    echo "ğŸ“§ Converto SÃ¤hkÃ¶postiasetukset:"
    echo "============================"
    echo ""
    echo "IMAP (SÃ¤hkÃ¶postin vastaanotto):"
    echo "   Server: mail.converto.fi"
    echo "   Port: 993"
    echo "   Security: SSL/TLS"
    echo "   Username: hello@converto.fi"
    echo ""
    echo "SMTP (SÃ¤hkÃ¶postin lÃ¤hetys):"
    echo "   Server: mail.converto.fi"
    echo "   Port: 587"
    echo "   Security: STARTTLS"
    echo "   Authentication: Required"
    echo "   Username: hello@converto.fi"
    echo ""
    echo "POP3 (vaihtoehtoinen):"
    echo "   Server: mail.converto.fi"
    echo "   Port: 995"
    echo "   Security: SSL/TLS"
}

# Function to update environment variables
update_env_config() {
    echo "ğŸ”§ PÃ¤ivitetÃ¤Ã¤n ympÃ¤ristÃ¶muuttujat..."
    
    # This would update .env with email configuration
    echo "# Converto Email Configuration" >> .env.tmp
    echo "CONVERTO_EMAIL_ENABLED=true" >> .env.tmp
    echo "CONVERTO_EMAIL_DOMAIN=converto.fi" >> .env.tmp
    echo "CONVERTO_EMAIL_SERVER=mail.converto.fi" >> .env.tmp
    echo "CONVERTO_EMAIL_PORT=587" >> .env.tmp
    echo "CONVERTO_EMAIL_SSL=true" >> .env.tmp
    echo "CONVERTO_EMAIL_USERNAME=hello@converto.fi" >> .env.tmp
    echo "CONVERTO_EMAIL_PASSWORD=[SET_EMAIL_PASSWORD]" >> .env.tmp
    echo "CONVERTO_EMAIL_SMTP_ENABLED=true" >> .env.tmp
    echo "" >> .env.tmp
    
    echo "âœ… Luotu .env.tmp - pÃ¤ivitÃ¤ .env-tiedosto kÃ¤sin"
}

# Main execution
main() {
    echo "ğŸš€ Aloitetaan Converto sÃ¤hkÃ¶postin asennus..."
    echo "Domain: $DOMAIN"
    echo "Name Server: $REGISTERED_NS"
    echo ""
    
    # Check current DNS status
    if ! check_dns_status; then
        echo "âš ï¸  DNS-tietueita ei ole konfiguroitu"
        echo "ğŸ“‹ Seuraavat toimet vaaditaan:"
        generate_cpanel_instructions
    else
        echo "âœ… DNS-tietueet lÃ¶ydetty"
    fi
    
    echo ""
    echo "ğŸ“‹ Seuraavat toimet:"
    echo "=================="
    
    # Generate instructions
    generate_cpanel_instructions
    create_email_integration
    
    echo ""
    echo "ğŸ§ª Testaamisen jÃ¤lkeen:"
    test_email_config
    
    echo ""
    echo "ğŸ’¡ Vinkit:"
    echo "  â€¢ Odota 15-30 min DNS-propagation muutosten jÃ¤lkeen"
    echo "  â€¢ Testaa sÃ¤hkÃ¶postin lÃ¤hetys ja vastaanotto"
    echo "  â€¢ Varmista ettÃ¤ SPF ja DKIM ovat kÃ¤ytÃ¶ssÃ¤"
    echo "  â€¢ KÃ¤ytÃ¤ turvallisia salasanoja"
    
    echo ""
    echo "âœ… Setup-valmis! Noudata cPanel-ohjeita ylhÃ¤Ã¤ltÃ¤."
}

# Run main function
main